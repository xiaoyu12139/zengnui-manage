const jsCodeTemplate=(e,t)=>`(() => {\n    const fn = ${String(e)}\n    const args = ${JSON.stringify(t)}\n    const callResult = (result) => {\n      if (!!result && (typeof result === 'object' || typeof result === 'function') && typeof result.then === 'function') {\n        return new Promise(resolve => {\n          result.then(ret => { resolve(callResult(ret)) }).catch( err => { resolve({ error: true, message: err.message }) })\n        })\n      }\n      return { data: result }\n    }\n    try {\n      return callResult(fn.apply(null, args))\n    } catch (err) { \n      return { error: true, message: err.message }\n    }\n  })()`,METHODS=["goto","hide","show","useragent","viewport","css","press","paste","screenshot","pdf","device","end","cookies","setCookies","removeCookies","clearCookies","devTools"];class UBrowserClient{constructor(){this._queue=[],METHODS.forEach((e=>{this[e]=(...t)=>(this._queue.push({method:e,args:t}),this)}))}evaluate(e,...t){if("function"!=typeof e)throw new Error("【evaluate 出错】参数必须是一个函数");return this._queue.push({method:"javascript",args:[jsCodeTemplate(e,t)]}),this}wait(...e){if("number"==typeof e[0])return this._queue.push({method:"wait",args:[e[0]]}),this;if("string"==typeof e[0]){const t=e[1];let n,r;return"object"==typeof t?(n=t.timeout,r=t.interval):"number"==typeof t&&(n=t),("number"!=typeof n||n<0)&&(n=6e4),("number"!=typeof r||r<0)&&(r=500),this._queue.push({method:"wait",args:[jsCodeTemplate((function(e){return Boolean(e.startsWith("/")||e.includes("//")?document.evaluate(e,document,null,window.XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue:document.querySelector(e))}),[e[0]]),n,r]}),this}if("function"==typeof e[0]){const t=e.shift(),n=e.shift();let r,o;return"object"==typeof n?(r=n.timeout,o=n.interval):"number"==typeof n&&(r=n),("number"!=typeof r||r<0)&&(r=6e4),("number"!=typeof o||o<0)&&(o=500),this._queue.push({method:"wait",args:[jsCodeTemplate(t,e),r,o]}),this}throw new Error("【wait 出错】参数错误")}when(...e){if("string"==typeof e[0])return this._queue.push({method:"when",args:[jsCodeTemplate((function(e){return Boolean(e.startsWith("/")||e.includes("//")?document.evaluate(e,document,null,window.XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue:document.querySelector(e))}),[e[0]])]}),this;if("function"==typeof e[0]){const t=e.shift();return this._queue.push({method:"when",args:[jsCodeTemplate(t,e)]}),this}throw new Error("【when 出错】参数错误")}mouse(e,...t){if(!["click","mousedown","mouseup"].includes(e))throw new Error("eventName error");if("string"==typeof t[0]){const n=t[0];return this.evaluate((function(e,t){document.activeElement.blur();const n=t.startsWith("/")||t.includes("//")?document.evaluate(t,document,null,window.XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue:document.querySelector(t);if(!n)throw new Error(e+': not find element "'+t+'"');const r=n.getBoundingClientRect(),o=new window.MouseEvent(e,{view:document.window,bubbles:!0,cancelable:!0,clientX:r.left+r.width/2,clientY:r.top+r.height/2});n.dispatchEvent(o)}),e,n)}if("number"==typeof t[0]){const n=t[0],r=t[1];if("number"!=typeof r)throw new Error(`【${e} 出错】第二个参数是一个数值`);return this._queue.push({method:"mouse",args:[e,n,r]}),this}throw new Error(`【${e} 出错】参数错误`)}click(...e){return this.mouse("click",...e)}mousedown(...e){return this.mouse("mousedown",...e)}mouseup(...e){return this.mouse("mouseup",...e)}file(e,t){let n;if("string"==typeof t)if(/^(data:image\/([a-z]+?);base64,)/.test(t)){const e=t.replace(RegExp.$1,""),r="image_"+Date.now()+"."+RegExp.$2,o=require("path"),s=require("fs"),u=o.join(require("os").tmpdir(),"utools-ubrowser");s.existsSync(u)||s.mkdirSync(u),n=[o.join(u,r)],s.writeFileSync(n[0],e,"base64")}else{if(!require("fs").existsSync(t))throw new Error("【file 出错】传入的第二个参数文件不存在");n=[t]}else if(t instanceof Uint8Array){const e="file_"+Date.now(),r=require("path"),o=require("fs"),s=r.join(require("os").tmpdir(),"utools-ubrowser");o.existsSync(s)||o.mkdirSync(s),n=[r.join(s,e)],o.writeFileSync(n[0],Buffer.from(t),"buffer")}else{if(!(Array.isArray(t)&&t.length>0&&"string"==typeof t[0]))throw new Error("【file 出错】参数错误");{const e=require("fs");if(t.find((t=>!e.existsSync(t))))throw new Error("【file 出错】传入的第二个参数文件不存在");n=t}}return this._queue.push({method:"file",args:[e,n]}),this}download(e,t,...n){return"function"==typeof e?(this._queue.push({method:"download",args:[jsCodeTemplate(e,n),t]}),this):(this._queue.push({method:"download",args:[e,t]}),this)}value(e,t){return this.evaluate((function(e,t){const n=e.startsWith("/")||e.includes("//")?document.evaluate(e,document,null,window.XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue:document.querySelector(e);if(!n)throw new Error(`【value 出错】未找到元素 "${e}"`);n.value=t,"TEXTAREA"===n.tagName||"INPUT"===n.tagName&&["text","password","search"].includes(n.type)?n.dispatchEvent(new window.Event("input",{bubbles:!0,cancelable:!0})):n.dispatchEvent(new window.Event("change",{bubbles:!0,cancelable:!0}))}),e,t)}check(e,t){return this.evaluate((function(e,t){const n=e.startsWith("/")||e.includes("//")?document.evaluate(e,document,null,window.XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue:document.querySelector(e);if(!n||"INPUT"!==n.tagName||!["checkbox","radio"].includes(n.type))throw new Error(`【check 出错】未找到 checkbox 或 radio 元素 "${e}"`);const r=void 0===t||!0===t;n.checked!==r&&(n.checked=r,n.dispatchEvent(new window.Event("change",{bubbles:!0,cancelable:!0})))}),e,t)}focus(e){return this.evaluate((function(e){const t=e.startsWith("/")||e.includes("//")?document.evaluate(e,document,null,window.XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue:document.querySelector(e);if(!t)throw new Error(`【focus 出错】未找到元素 "${e}"`);t.focus()}),e)}scroll(...e){if("number"==typeof e[0]){if(1===e.length)return this.evaluate((e=>{window.scrollTo(window.scrollX,e)}),e[0]);if(2===e.length&&"number"==typeof e[1])return this.evaluate(((e,t)=>{window.scrollTo(e,t)}),e[0],e[1]);throw new Error("【scroll 出错】参数错误")}if("string"==typeof e[0])return this.evaluate((function(e){const t=e.startsWith("/")||e.includes("//")?document.evaluate(e,document,null,window.XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue:document.querySelector(e);if(!t)throw new Error(`【scroll 出错】未找到元素 "${e}"`);const n=t.getBoundingClientRect();window.scrollTo(n.left,n.top)}),e[0]);throw new Error("【scroll 出错】参数错误")}}module.exports=new UBrowserClient;
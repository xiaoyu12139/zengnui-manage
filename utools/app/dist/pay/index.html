<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimal-ui">
  <style type="text/css">
    html, body { 
      width: 100%; 
      height: 100%; 
      margin: 0; 
      padding: 0;
      background-color: #f4f4f4;
      overflow: hidden;
    }
    body {
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      display: flex;
      flex-direction: column;
      user-select: none;
    }

    header { 
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 42px;
      padding-left: 16px;
      font-size: 13px;
      border-bottom: 1px solid #dadada;
      box-sizing: border-box;
    }

    #root {
      min-height: 0;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .close {
      width: 48px;
      height: 42px;
      cursor: pointer;
      position: relative;
    }
    .close:hover:before, .close:hover:after{
      background-color: #363636;
    }
    .close:before, .close:after {
      position: absolute;
      left: 24px;
      top: 13px;
      content: ' ';
      height: 16px;
      width: 1px;
      background-color: #777;
    }
    .close:before {
      transform: rotate(45deg);
    }
    .close:after {
      transform: rotate(-45deg);
    }

    @keyframes sk-bouncedelay { 0%, 80%, 100% { transform: scale(0);} 40% { transform: scale(1.0); } }
    .spinner { 
      margin: 50% auto 0;
      text-align: center;
    }
    .spinner > div { 
      width: 8px;
      height: 8px;
      background-color: #888;
      border-radius: 100%;
      display: inline-block;
      animation: sk-bouncedelay 1s infinite ease-in-out both;
    }
    .spinner .bounce1 {
      animation-delay: -0.32s;
    }
    .spinner .bounce2 {
      animation-delay: -0.16s;
    }

    .body {
      padding: 0 24px;
      box-sizing: border-box;
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
    }

    .top {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 160px;
    }

    .title {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .title > img {
      width: 18px;
      height: 18px;
      margin-right: 8px;
    }

    .title > div {
      max-width: 80%;
      font-size: 16px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .price {
      text-align: center;
      font-size: 32px;
      margin-top: 8px;
      display: flex;
      align-items: flex-start;
    }

    .price > span {
      font-size: 22px;
      margin-top: 3px;
      margin-right: 4px;
    }

    .vip-price {
      margin-top: 8px;
      font-size: 14px;
      color: #E59C16;
    }

    .vip-total-fee {
      margin-top: 8px;
      background: linear-gradient(to right, #FDCA6A, #FBD58E);
      color: #875700;
      font-size: 14px;
      padding: 6px 16px;
      border-radius: 20px;
    }

    .normal {
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
    }

    .info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 14px;
    }
    .info > div {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
      box-sizing: border-box;
      border-bottom: 1px solid #dadada;
    }

    .info > div > div:first-child {
      color: #737373;
    }

    .info > div > div:last-child {
      max-width: 74%;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;
      overflow: hidden;
    } 

    .info > p {
      font-size: 12px;
      color: #888;
      margin: 0;
      word-break: break-all;
      line-height: 1.5;
    }

    .handle {
      height: 82px;
    }

    .wechat-pay-btn { 
      width: 100%;
      height: 42px;
      border-radius: 21px;
      background-color: #0cbd65;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 600;
      color: #fff;
      cursor: pointer;
    }
    .wechat-pay-btn > img {
      width: 20px;
      margin-right: 8px;
      margin-top: 2px;
    }

    .buy-vip {
      width: 100%;
      text-align: center;
      padding-top: 8px;
      font-size: 13px;
    }

    .buy-vip > a {
      color: #E59C16;
      padding-left: 2px;
      cursor: pointer;
    }

    .qr-content {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: start;
    }

    .qr-content > div:last-child {
      font-size: 14px;
      padding-top: 6px;
    }

    .qr-code {
      padding: 8px;
      box-sizing: border-box;
      border-radius: 5px;
      background-color: #fff;
    }

    .error { 
      width: 100%; 
      flex: 1;
      text-align: center;
      color: #FF4E2A;
      word-wrap: break-word;
      word-break: break-all;
      background: center / 220px no-repeat url("error-bg.png");
    }
    .error > h3 {
      margin-bottom: 10px;
    }
    .error > div {
      font-size: 14px;
      padding: 0 24px;
      line-height: 1.4;
      box-sizing: border-box;
      word-break: break-all;
      color: #333;
    }

    .login-btn {
      width: 80%;
      text-align: center;
      padding: 10px 0;
      box-sizing: border-box;
      font-size: 14px;
      color: #fff;
      background-color: #212224;
      cursor: pointer;
      border-radius: 20px;
      position: absolute;
      bottom: 36px;
      left: 50%;
      transform: translateX(-50%);
      box-shadow: rgba(0, 0, 0, 0.2) 0px 3px 1px -2px, rgba(0, 0, 0, 0.14) 0px 2px 2px 0px, rgba(0, 0, 0, 0.12) 0px 1px 5px 0px;
    }

    @media (prefers-color-scheme: dark) {
      body {
        background-color: #303133;
        color: #fff;
      }
      header { 
        border-color:#555;
      }
      .close:hover:before, .close:hover:after{
        background-color: #ddd;
      }
      .close:before, .close:after {
        background-color: #aaa;
      }
      .info > div {
        border-color: #555;
      }
      .info > div > div:first-child {
        color: #ccc;
      }
      .error > div {
        color: #f6f6f6;
      }
      .login-btn {
        background-color: #555;
      }
    }
  </style>
</head>
<body>
  <header>
    <div>uTools 收银台</div>
    <div onclick="window.services.closeWindow()" class="close"></div>
  </header>
  <div id='root'>
    <div class="spinner">
      <div class="bounce1"></div>
      <div class="bounce2"></div>
      <div class="bounce3"></div>
    </div>
  </div>
  <script src="qrcode.min.js"></script>
  <script>
    const getText = (str) => {
      if (!str) return ''
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/`/g, '\`')
    }
    window.initRender = ({ pluginLogo, pluginName, payCodeURL, order }) => {
      const isFF = order.plugin_name === 'FFFFFFFF'
      window._data_ = { payCodeURL, order }
      document.getElementById('root').innerHTML = `
        <div class="body">
          <div class="top">
            <div class="title">
              <img src="${pluginLogo}" alt="" draggable="false" /><div>${getText(pluginName)}</div>
            </div>
            <div class="price">
              ${
                order.is_member && !isFF
                  ? `<span>￥</span><del>${(order.pay_fee / 100).toFixed(2)}</del>`
                  : `<span>￥</span>${(order.total_fee / 100).toFixed(2)}`
              }
            </div>
            ${
              isFF
                ?  ''
                : order.is_member
                  ? `<div class="vip-total-fee">会员专享价 ￥${(order.total_fee / 100).toFixed(2)}</div>`
                  : `<div class="vip-price">会员优惠价 ￥${(order.member_fee / 100).toFixed(2)}</div>`
            }
          </div>
          <div class="normal">
            <div class="info">
              <div class="info-row">
                <div>购买</div>
                <div>${getText(order.body)}</div>
              </div>
              <div class="info-row">
                <div>收款方</div>
                <div>${getText(order.payee)}</div>
              </div>
              ${
                isFF
                  ? '' 
                  : `<p>本次收款由第三方插件应用「${getText(pluginName)}」发起，uTools 收到款项后将支付给此插件应用开发者</p>`
              }
            </div>
            <div class="handle">
              <div onclick="handle.wechatPay()" class="wechat-pay-btn">
                <img src="wechat.png" alt="" /><span>微信支付</span>
              </div>
              ${
                isFF || order.is_member
                  ? ''
                  : `<div class="buy-vip">享会员优惠价，马上<a onclick="window.services.goAccount()">升级会员</a></div>`
              }
            </div>
          </div>
        <div>`
    }
    window.initRenderError = (error, unlogin) => {
      document.getElementById('root').innerHTML = `
        <div class="body">
          <div class="error">
            <h3>出错了</h3>
            <div>${getText(error)}</div>
          </div>
          ${unlogin ? '<div class="login-btn" onclick="window.services.goAccount()">前往登录 uTools 账号</div>' : ''}
        </div>`
    }
    window.handle = {
      wechatPay: async ()  => {
        const { payCodeURL, order } = window._data_
        const response = await window.fetch(payCodeURL)
        if (!response.ok) return
        const result = await response.json()
        document.querySelector('.normal').innerHTML = `
          <div class="qr-content">
            <div class="qr-code">
              <div></div>
            </div>
            <div>微信扫码支付</div>
          </div>`
        const qrcodeDom = document.querySelector(".qr-code > div")
        new QRCode(qrcodeDom, { 
          text: result.message,
          width: 180,
          height: 180,
          correctLevel : QRCode.CorrectLevel.L
        })
        qrcodeDom.removeAttribute('title')
        window.services.startLoopCheckOrderResult(order.order_id)
      }
    }
  </script>
</body>
</html>
